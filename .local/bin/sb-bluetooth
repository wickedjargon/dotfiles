#!/bin/sh

# Usage: sb-bluetooth MAC
# Example: sb-bluetooth "3C:B0:ED:A7:6A:88"

MAC="${1:-}"

if [ -z "$MAC" ]; then
    exit 0
fi

# Check if the device is connected (with timeout)
connected=$(timeout 2 bluetoothctl info "$MAC" 2>/dev/null | awk '/Connected:/ {print $2}')

if [ "$connected" = "yes" ]; then
    # Try to get battery percentage with retries
    battery=""
    max_attempts=5
    attempt=0
    
    while [ $attempt -lt $max_attempts ] && [ -z "$battery" ]; do
        battery=$(timeout 2 bluetoothctl info "$MAC" 2>/dev/null | grep "Battery Percentage" | grep -oP '\(\K[0-9]+')
        if [ -z "$battery" ]; then
            attempt=$((attempt + 1))
            [ $attempt -lt $max_attempts ] && sleep 0.3
        fi
    done
    
    if [ -n "$battery" ]; then
        echo "ðŸŽ§ ${battery}%"
    else
        echo "ðŸŽ§ --"
    fi
else
    # Don't show anything when not connected
    echo ""
fi
