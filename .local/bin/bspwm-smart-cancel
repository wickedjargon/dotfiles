#!/usr/bin/env python3
import subprocess
import json
import sys
import os

"""Cancel preselection and restore state for bspwm."""

STATE_FILE = "/tmp/bspwm_smart_arrow_state.json"

class BspwmSmartCancel:
    def get_layout(self):
        try:
            output = subprocess.check_output(["bspc", "query", "-T", "-d"], text=True)
            data = json.loads(output)
            return data.get("layout")
        except (subprocess.CalledProcessError, json.JSONDecodeError):
            return None

    def is_fullscreen(self):
        try:
            subprocess.check_call(["bspc", "query", "-N", "-n", "focused.fullscreen"], 
                                  stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            return True
        except subprocess.CalledProcessError:
            return False

    def run(self):
        # Cancel preselection
        subprocess.run(["bspc", "node", "-p", "cancel"])
        
        if os.path.exists(STATE_FILE):
            try:
                with open(STATE_FILE, 'r') as f:
                    state = json.load(f)
                
                prev_layout = state.get("PREV_LAYOUT")
                was_fullscreen = state.get("WAS_FULLSCREEN")
                
                # Restore Layout
                current_layout = self.get_layout()
                if prev_layout and prev_layout != current_layout:
                    subprocess.run(["bspc", "desktop", "-l", prev_layout])
                
                # Restore Fullscreen
                is_fs = self.is_fullscreen()
                if was_fullscreen and not is_fs:
                     subprocess.run(["bspc", "node", "focused", "-t", "~fullscreen"])
                
                os.remove(STATE_FILE)
            except (IOError, json.JSONDecodeError):
                pass

if __name__ == "__main__":
    BspwmSmartCancel().run()
