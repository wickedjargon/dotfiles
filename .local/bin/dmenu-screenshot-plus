#!/usr/bin/env python3
import os
import subprocess
import datetime
import re
import sys
import importlib.util
import importlib.machinery

DMENU_CONFIG_PATH = os.path.expanduser("~/.config/dmenu/config")
SCREENSHOT_DIR = "/tmp"


def _import_upload_selection():
    path = os.path.join(os.path.dirname(os.path.abspath(__file__)), "upload-selection")
    loader = importlib.machinery.SourceFileLoader("upload_selection", path)
    spec = importlib.util.spec_from_loader("upload_selection", loader)
    mod = importlib.util.module_from_spec(spec)
    loader.exec_module(mod)
    return mod


_upload_mod = _import_upload_selection()
upload_file_to_0x0 = _upload_mod.upload_file_to_0x0
copy_to_clipboard = _upload_mod.copy_to_clipboard
notify = _upload_mod.notify


def get_dmenu_args():
    dmenu_args = []
    font = ""
    if os.path.exists(DMENU_CONFIG_PATH):
        with open(DMENU_CONFIG_PATH, "r") as f:
            for line in f:
                line = line.strip()
                if line.startswith("DMENU_BASIC_ARGS="):
                    match = re.search(r'DMENU_BASIC_ARGS="([^"]+)"', line)
                    if match:
                        dmenu_args = match.group(1).split()
                elif line.startswith("DMENU_FONT="):
                    match = re.search(r'DMENU_FONT="([^"]+)"', line)
                    if match:
                        font = match.group(1)
    cmd = ["dmenu"] + dmenu_args
    if font:
        cmd.extend(["-fn", font])
    cmd.extend(["-i", "-p"])
    return cmd


def run_dmenu(options, prompt):
    cmd = get_dmenu_args() + [prompt]
    input_str = "\n".join(options).encode('utf-8')
    try:
        p = subprocess.Popen(cmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, _ = p.communicate(input=input_str)
        return stdout.decode('utf-8').strip()
    except FileNotFoundError:
        notify("Error", "dmenu not found")
        sys.exit(1)


def take_screenshot(rect=False):
    filename = os.path.join(SCREENSHOT_DIR, f"screenshot-{datetime.datetime.now().strftime('%Y%m%d-%H%M%S-%f')}.png")
    cmd = ["maim"]
    if rect:
        cmd.append("-s")
    cmd.append(filename)
    try:
        subprocess.run(cmd, check=True)
        if os.path.exists(filename):
            return filename
    except subprocess.CalledProcessError:
        return None
    return None


def main():
    opt_full = "Full Screenshot"
    opt_region = "Region Screenshot"
    selection = run_dmenu([opt_full, opt_region], "Screenshot:")
    if not selection:
        return
    filepath = take_screenshot(rect=(selection == opt_region))
    if not filepath:
        return
    opt_save = "Save to /tmp/ (Clip Path)"
    opt_upload = "Upload to 0x0.st (Clip URL)"
    action = run_dmenu([opt_save, opt_upload], "Action:")
    if action == opt_save:
        copy_to_clipboard(filepath)
        notify("Screenshot Saved", f"Saved to {filepath}\nPath copied to clipboard")
    elif action == opt_upload:
        notify("Uploading...", "Please wait...")
        url = upload_file_to_0x0(filepath)
        if url:
            copy_to_clipboard(url)
            notify("Upload Successful", f"URL copied: {url}")
        else:
            notify("Upload Failed", "Could not upload to 0x0.st")


if __name__ == "__main__":
    main()
