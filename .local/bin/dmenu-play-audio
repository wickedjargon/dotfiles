#!/usr/bin/env python3
"""
dmenu-play-audio

Select a song from ~/d/audio and play it using mpd.
Requires: dmenu, mpd, mpc, python3
"""

import os
import subprocess

from pathlib import Path

# Configuration
AUDIO_DIR = Path.home() / "d" / "audio"
SUPPORTED_EXTENSIONS = {'.mp3', '.flac', '.ogg', '.wav', '.m4a'}


def get_audio_files():
    """Recursively find audio files."""
    files = []
    if not AUDIO_DIR.exists():
        return []

    for root, _, filenames in os.walk(AUDIO_DIR):
        for name in filenames:
            if Path(name).suffix.lower() in SUPPORTED_EXTENSIONS:
                # Store relative path for display/mpd compatibility if needed,
                # but for 'mpc add', absolute path is safer if mpd is configured for it.
                # However, usually MPD expects paths relative to its music directory.
                # If ~/d/audio IS the music directory, we should use relative paths.
                # Let's try to assume ~/d/audio is the root or we use absolute paths file://
                
                # Using absolute path with file:// protocol is robust if MPD supports it
                full_path = os.path.join(root, name)
                
                # For display, we want something readable. Relpath is good.
                rel_path = os.path.relpath(full_path, AUDIO_DIR)
                files.append((rel_path, full_path))
                
    # Sort by relative path
    files.sort(key=lambda x: x[0])
    return files


def load_dmenu_config():
    """Load dmenu arguments from config file"""
    config_path = os.path.expanduser("~/.config/dmenu/config")
    args = []
    font = ""
    
    if os.path.exists(config_path):
        with open(config_path, "r") as f:
            for line in f:
                if line.startswith("DMENU_BASIC_ARGS="):
                    # Extract args, remove quotes
                    val = line.split("=", 1)[1].strip().strip('"')
                    args.extend(val.split())
                elif line.startswith("DMENU_FONT="):
                    # Extract font, remove quotes
                    font = line.split("=", 1)[1].strip().strip('"')
    
    return args, font


def dmenu_select(options, args, font):
    """Present options in dmenu and return selected."""
    dmenu_input = "\n".join([x[0] for x in options])
    
    cmd = ["dmenu", "-p", "Play Song:", "-i"] + args
    if font:
        cmd.extend(["-fn", font])
    
    try:
        result = subprocess.run(
            cmd,
            input=dmenu_input,
            capture_output=True,
            text=True,
            check=True
        )
        return result.stdout.strip()
    except subprocess.CalledProcessError:
        return None


def main():
    if not subprocess.run(["which", "mpc"], capture_output=True).returncode == 0:
        subprocess.run(["notify-send", "Error", "mpc is not installed"])
        return

    songs = get_audio_files()
    if not songs:
        subprocess.run(["notify-send", "Error", f"No audio files found in {AUDIO_DIR}"])
        return

    args, font = load_dmenu_config()
    selected_name = dmenu_select(songs, args, font)
    if not selected_name:
        return

    if selected_name:
        # Use mpc to play
        # We'll clear the playlist and add the file
        subprocess.run(["mpc", "clear"], check=False)
        
        # MPD requires paths relative to music_directory
        subprocess.run(["mpc", "add", selected_name], check=False)
        subprocess.run(["mpc", "play"], check=False)
        
        # Notify
        subprocess.run(["notify-send", "Now Playing", selected_name])

if __name__ == "__main__":
    main()
