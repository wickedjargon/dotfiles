#!/usr/bin/env python3
import subprocess
import re
import sys
import shutil

"""Manage external displays via rofi and xrandr."""

class DisplayManager:
    def notify(self, message):
        subprocess.run(["notify-send", "Display", message])

    def get_xrandr_output(self):
        try:
            return subprocess.check_output(["xrandr", "--query"], text=True)
        except subprocess.CalledProcessError:
            self.notify("Error running xrandr")
            return ""

    def get_internal(self):
        output = self.get_xrandr_output()
        # Regex to find internal display (LVDS, eDP, etc.)
        match = re.search(r"^(LVDS|eDP|eDP-?[0-9]*)-?[0-9]* connected", output, re.MULTILINE)
        if match:
            return match.group(0).split()[0]
        return None

    def get_externals(self):
        internal = self.get_internal()
        output = self.get_xrandr_output()
        # Find all connected displays
        connected = re.findall(r"^(\S+) connected", output, re.MULTILINE)
        # Filter out internal
        return [d for d in connected if d != internal]

    def rofi_select(self, prompt, items):
        if not items:
            return None
        input_str = "\n".join(items)
        try:
            result = subprocess.run(
                ["rofi", "-dmenu", "-i", "-p", prompt],
                input=input_str,
                capture_output=True,
                text=True,
                check=True
            )
            return result.stdout.strip()
        except subprocess.CalledProcessError:
            return None

    def apply_config(self, mode, external):
        internal = self.get_internal()
        if not internal:
            self.notify("Could not detect internal display")
            return

        cmd = ["xrandr"]
        
        if mode == "mirror":
             cmd.extend(["--output", internal, "--auto", "--output", external, "--auto", "--same-as", internal])
             msg = f"Mirroring to {external}"
        elif mode == "extend-right":
             cmd.extend(["--output", internal, "--auto", "--output", external, "--auto", "--right-of", internal])
             msg = f"Extended to {external} (right)"
        elif mode == "extend-left":
             cmd.extend(["--output", internal, "--auto", "--output", external, "--auto", "--left-of", internal])
             msg = f"Extended to {external} (left)"
        elif mode == "extend-above":
             cmd.extend(["--output", internal, "--auto", "--output", external, "--auto", "--above", internal])
             msg = f"Extended to {external} (above)"
        elif mode == "external-only":
             cmd.extend(["--output", internal, "--off", "--output", external, "--auto"])
             msg = f"Using {external} only"
        elif mode == "laptop-only":
             # Turn off all externals
             externals = self.get_externals() # Re-fetch to be safe
             for ext in externals:
                 cmd.extend(["--output", ext, "--off"])
             cmd.extend(["--output", internal, "--auto"])
             msg = "Using laptop display only"
        else:
             return

        if subprocess.run(cmd).returncode == 0:
            self.notify(msg)
        else:
            self.notify("Failed to apply display configuration")

    def run(self):
        if not shutil.which("xrandr") or not shutil.which("rofi"):
             self.notify("Error: xrandr or rofi not found")
             sys.exit(1)

        externals = self.get_externals()
        
        if not externals:
            self.notify("No external displays detected")
            sys.exit(0)

        selected_external = None
        if len(externals) > 1:
            selected_external = self.rofi_select("Select display", externals)
            if not selected_external:
                sys.exit(0)
        else:
            selected_external = externals[0]

        # Action Menu
        actions = {
            f"Mirror to {selected_external}": "mirror",
            f"Extend right ({selected_external})": "extend-right",
            f"Extend left ({selected_external})": "extend-left",
            f"Extend above ({selected_external})": "extend-above",
            f"External only ({selected_external})": "external-only",
            "Laptop only": "laptop-only"
        }

        # Need to preserve order for rofi menu
        action_labels = list(actions.keys())
        # Add padding to align somewhat if needed, or just list them. original used printf format.
        # Python dicts are ordered insertion (3.7+).
        
        selected_action_label = self.rofi_select("Display", action_labels)
        if not selected_action_label:
            sys.exit(0)

        # Match partial string if needed or exact match
        # Original script used case "$action" in *Mirror*
        # Here we used specific keys so we can look it up directly?
        # rofi returns exactly one of the input lines.
        
        mode = actions.get(selected_action_label)
        if mode:
            self.apply_config(mode, selected_external)

if __name__ == "__main__":
    DisplayManager().run()
