#!/usr/bin/env python3

import os
import subprocess


def load_dmenu_config():
    """Load dmenu arguments from config file"""
    config_path = os.path.expanduser("~/.config/dmenu/config")
    args = []
    font = ""
    
    if os.path.exists(config_path):
        with open(config_path, "r") as f:
            for line in f:
                if line.startswith("DMENU_BASIC_ARGS="):
                    # Extract args, remove quotes
                    val = line.split("=", 1)[1].strip().strip('"')
                    args.extend(val.split())
                elif line.startswith("DMENU_FONT="):
                    # Extract font, remove quotes
                    font = line.split("=", 1)[1].strip().strip('"')
    
    return args, font

def get_scripts():
    """List executable files in ~/.local/bin"""
    bin_dir = os.path.expanduser("~/.local/bin")
    scripts = []
    
    if not os.path.exists(bin_dir):
        return []

    for filename in os.listdir(bin_dir):
        filepath = os.path.join(bin_dir, filename)
        
        # Check if file and executable
        if os.path.isfile(filepath) and os.access(filepath, os.X_OK):
             scripts.append(filename)
            
    return sorted(scripts)

def dmenu_select(prompt, items, args, font):
    if not items:
        return None
        
    cmd = ["dmenu", "-p", prompt, "-i"] + args
    if font:
        cmd.extend(["-fn", font])
        
    input_str = "\n".join(items)
    try:
        result = subprocess.run(
            cmd,
            input=input_str,
            capture_output=True,
            text=True,
            check=True
        )
        return result.stdout.strip()
    except subprocess.CalledProcessError:
        return None

def main():
    scripts = get_scripts()
    
    if not scripts:
        subprocess.run(["notify-send", "Error", "No scripts found in ~/.local/bin"])
        return

    args, font = load_dmenu_config()
    selected = dmenu_select("Run script:", scripts, args, font)
    
    if selected:
        # Execute the script
        script_path = os.path.join(os.path.expanduser("~/.local/bin"), selected)
        # Run in background
        subprocess.Popen([script_path])

if __name__ == "__main__":
    main()
