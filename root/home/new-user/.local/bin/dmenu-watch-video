#!/usr/bin/env python3
"""
dmenu-watch-video

Select a video from ~/d/videos and play it using mpv.
Requires: dmenu, mpv, python3
"""

import os
import subprocess
from pathlib import Path

# Configuration
VIDEOS_DIR = Path.home() / "d" / "videos"
SUPPORTED_EXTENSIONS = {'.mp4', '.mkv', '.avi', '.mov', '.webm', '.flv', '.wmv'}


def load_dmenu_config():
    """Load dmenu arguments from config file"""
    config_path = os.path.expanduser("~/.config/dmenu/config")
    args = []
    font = ""
    
    if os.path.exists(config_path):
        with open(config_path, "r") as f:
            for line in f:
                if line.startswith("DMENU_BASIC_ARGS="):
                    val = line.split("=", 1)[1].strip().strip('"')
                    args.extend(val.split())
                elif line.startswith("DMENU_FONT="):
                    font = line.split("=", 1)[1].strip().strip('"')
    
    return args, font


def dmenu_select(options, args, font, prompt="Select:"):
    """Present options in dmenu and return selected."""
    dmenu_input = "\n".join([x[0] for x in options])
    
    cmd = ["dmenu", "-p", prompt, "-i"] + args
    if font:
        cmd.extend(["-fn", font])
    
    try:
        result = subprocess.run(
            cmd,
            input=dmenu_input,
            capture_output=True,
            text=True,
            check=True
        )
        return result.stdout.strip()
    except subprocess.CalledProcessError:
        return None


def get_files(directory, extensions):
    """Recursively find files with matching extensions."""
    files = []
    if not directory.exists():
        return []

    for root, _, filenames in os.walk(directory):
        for name in filenames:
            if Path(name).suffix.lower() in extensions:
                full_path = os.path.join(root, name)
                rel_path = os.path.relpath(full_path, directory)
                files.append((rel_path, full_path))
                
    files.sort(key=lambda x: x[0])
    return files


def main():
    files = get_files(VIDEOS_DIR, SUPPORTED_EXTENSIONS)
    if not files:
        subprocess.run(["notify-send", "Error", f"No videos found in {VIDEOS_DIR}"])
        return

    args, font = load_dmenu_config()
    selected_name = dmenu_select(files, args, font, prompt="Watch Video:")
    
    if selected_name:
        full_path = next((x[1] for x in files if x[0] == selected_name), None)
        if full_path:
            subprocess.Popen(["mpv", full_path])

if __name__ == "__main__":
    main()
