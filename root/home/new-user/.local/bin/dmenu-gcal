#!/usr/bin/env python3
"""
dmenu-gcal — Add events to Google Calendar via dmenu with natural language.

Uses Google Calendar's quickAdd() to parse natural language date/time strings
(e.g. "Dentist next Tuesday at 10am").

SETUP
-----
1. Go to https://console.cloud.google.com/
2. Create a project (or use an existing one).
3. Enable the "Google Calendar API".
4. Go to Credentials → Create Credentials → OAuth client ID → Desktop app.
5. Download the JSON and save it as:
       ~/.config/dmenu-gcal/credentials.json
6. Make this script executable:
       chmod +x ~/.local/bin/dmenu-gcal
7. On first run, a browser window will open for OAuth consent.
   After granting access, a token is cached at:
       ~/.config/dmenu-gcal/token.json
8. (Optional) Bind to a key in sxhkdrc.

DEBIAN 13 DEPENDENCIES
----------------------
    sudo apt install python3-googleapi python3-google-auth-oauthlib
"""

import os
import subprocess
import sys
from pathlib import Path

from google.oauth2.credentials import Credentials
from google.auth.transport.requests import Request
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build

CONFIG_DIR = Path.home() / ".config" / "dmenu-gcal"
CREDENTIALS_FILE = CONFIG_DIR / "credentials.json"
TOKEN_FILE = CONFIG_DIR / "token.json"
SCOPES = ["https://www.googleapis.com/auth/calendar.events"]


def load_dmenu_config():
    """Load dmenu arguments from config file."""
    config_path = os.path.expanduser("~/.config/dmenu/config")
    args = []
    font = ""
    if os.path.exists(config_path):
        with open(config_path, "r") as f:
            for line in f:
                if line.startswith("DMENU_BASIC_ARGS="):
                    val = line.split("=", 1)[1].strip().strip('"')
                    args.extend(val.split())
                elif line.startswith("DMENU_FONT="):
                    font = line.split("=", 1)[1].strip().strip('"')
    return args, font


def dmenu_prompt(args, font):
    """Show dmenu with an empty input and return the user's typed string."""
    cmd = ["dmenu", "-p", "Calendar:", "-i"] + args
    if font:
        cmd.extend(["-fn", font])
    try:
        result = subprocess.run(
            cmd, input="", capture_output=True, text=True, check=True
        )
        return result.stdout.strip()
    except subprocess.CalledProcessError:
        return None


def notify(title, body):
    """Send a desktop notification."""
    subprocess.run(["notify-send", title, body])


def get_calendar_service():
    """Authenticate and return a Google Calendar API service object."""
    creds = None

    if TOKEN_FILE.exists():
        creds = Credentials.from_authorized_user_file(str(TOKEN_FILE), SCOPES)

    if creds and creds.expired and creds.refresh_token:
        creds.refresh(Request())
    elif not creds or not creds.valid:
        if not CREDENTIALS_FILE.exists():
            notify(
                "Calendar Error",
                f"credentials.json not found at {CREDENTIALS_FILE}\n"
                "See the script header for setup instructions.",
            )
            sys.exit(1)
        flow = InstalledAppFlow.from_client_secrets_file(
            str(CREDENTIALS_FILE), SCOPES
        )
        creds = flow.run_local_server(port=0)

    # Cache the token for next time
    CONFIG_DIR.mkdir(parents=True, exist_ok=True)
    with open(TOKEN_FILE, "w") as f:
        f.write(creds.to_json())

    return build("calendar", "v3", credentials=creds)


def add_event(service, text):
    """Use quickAdd to create an event from a natural language string.

    Returns the created event dict on success, or raises on failure.
    """
    return service.events().quickAdd(calendarId="primary", text=text).execute()


def format_event_time(event):
    """Extract a human-readable start time from the API response."""
    start = event.get("start", {})
    # quickAdd may return dateTime or date depending on the event
    return start.get("dateTime", start.get("date", "unknown time"))


def main():
    args, font = load_dmenu_config()
    text = dmenu_prompt(args, font)

    if not text:
        sys.exit(0)

    try:
        service = get_calendar_service()
        event = add_event(service, text)
        summary = event.get("summary", text)
        when = format_event_time(event)
        notify("Calendar Event Added", f"{summary}\n{when}")
    except Exception as e:
        notify("Calendar Error", str(e))
        sys.exit(1)


if __name__ == "__main__":
    main()
