#!/bin/bash

# Control volume and update xob
# Usage: xob-volume [up|down|mute]

PIPE="/tmp/xobpipe"

# Ensure pipe exists to avoid errors, though .xinitrc should manage it
if [ ! -p "$PIPE" ]; then
    exit 1
fi

# Get current volume percentage
current=$(pactl get-sink-volume @DEFAULT_SINK@ | head -n1 | grep -o '[0-9]\+%' | head -n1 | tr -d '%')

case "$1" in
    up)
        # Round down to nearest 5, then add 5
        target=$(( (current / 5) * 5 + 5 ))
        # Cap at 150%
        [ "$target" -gt 150 ] && target=150
        pactl set-sink-volume @DEFAULT_SINK@ "${target}%"
        ;;
    down)
        # Round up to nearest 5, then subtract 5
        target=$(( ((current + 4) / 5) * 5 - 5 ))
        # Floor at 0%
        [ "$target" -lt 0 ] && target=0
        pactl set-sink-volume @DEFAULT_SINK@ "${target}%"
        ;;
    mute)
        pactl set-sink-mute @DEFAULT_SINK@ toggle
        ;;
esac

# Get updated volume percentage
vol=$(pactl get-sink-volume @DEFAULT_SINK@ | head -n1 | grep -o '[0-9]\+%' | head -n1 | tr -d '%')

# Get mute status
mute_status=$(pactl get-sink-mute @DEFAULT_SINK@)

# Write to pipe with timeout to prevent hanging if xob isn't reading
if [[ "$mute_status" == *"yes"* ]]; then
    timeout 0.2s bash -c "echo \"${vol}!\" > $PIPE"
else
    timeout 0.2s bash -c "echo \"$vol\" > $PIPE"
fi
