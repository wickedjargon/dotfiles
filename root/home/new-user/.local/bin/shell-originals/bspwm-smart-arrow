#!/bin/sh

direction=$1

if [ -z "$direction" ]; then
    echo "Usage: $0 <direction>"
    exit 1
fi

# Get State
count=$(bspc query -N -d focused -n .leaf.!hidden.window | wc -l)
is_fullscreen=$(bspc query -N -n focused.fullscreen >/dev/null && echo "true" || echo "false")
# Robustly grep layout from json output since jq might not be available
layout=$(bspc query -T -d | grep -o '"layout":"[^"]*"' | head -n1 | cut -d'"' -f4)

# Decision Logic
allowed=true

if [ "$is_fullscreen" = "true" ]; then
    # If Fullscreen: Only allow if it's the only window
    if [ "$count" -gt 1 ]; then
        allowed=false
    fi
elif [ "$layout" = "monocle" ]; then
    # If Monocle: Only allow if it's the only window
    if [ "$count" -gt 1 ]; then
        allowed=false
    fi
fi

# Execute or Notify
if [ "$allowed" = "true" ]; then
    # If we have no windows, we can't preselect off a node, so check count >= 1
    if [ "$count" -ge 1 ]; then
        # 0. Save State
        state_file="/tmp/bspwm_smart_arrow_state"
        echo "WAS_FULLSCREEN=$is_fullscreen" > "$state_file"
        echo "PREV_LAYOUT=$layout" >> "$state_file"

        # 1. Exit Fullscreen if needed
        if [ "$is_fullscreen" = "true" ]; then
            bspc node focused -t ~fullscreen
        fi
        
        # 2. Ensure Tiled Layout
        if [ "$layout" != "tiled" ]; then
            bspc desktop -l tiled
        fi
        
        # 3. Preselect
        bspc node -p "$direction"
    fi
else
    # Optional feedback
    notify-send "Smart Arrow" "Split blocked: Multiple windows in Fullscreen/Monocle mode."
fi
