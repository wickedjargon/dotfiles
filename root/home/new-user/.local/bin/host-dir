#!/usr/bin/env python3
"""Serve the current directory over HTTP.

Starts on port 9000 by default. If that port is taken, automatically
increments until a free port is found. Prints the LAN-accessible URL
so you can open it on another device (e.g. a phone).
"""

import http.server
import socket
import socketserver
import subprocess
import sys


def get_local_ip():
    """Return the machine's LAN IP address.

    Tries a UDP-connect trick first (no traffic sent), then falls back
    to parsing ``hostname -I``.  Returns '127.0.0.1' if everything fails.
    """
    # Method 1: UDP connect trick
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_DGRAM) as s:
            s.connect(("10.255.255.255", 1))
            ip = s.getsockname()[0]
            if ip and not ip.startswith("127."):
                return ip
    except OSError:
        pass

    # Method 2: hostname -I
    try:
        result = subprocess.run(
            ["hostname", "-I"],
            capture_output=True, text=True, timeout=5,
        )
        if result.returncode == 0 and result.stdout.strip():
            return result.stdout.strip().split()[0]
    except (FileNotFoundError, subprocess.TimeoutExpired, OSError):
        pass

    return "127.0.0.1"


def find_available_port(start=9000, max_attempts=100):
    """Return the first available TCP port starting from *start*.

    Raises ``RuntimeError`` if no port is free within *max_attempts*.
    """
    for offset in range(max_attempts):
        port = start + offset
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.bind(("", port))
                return port
        except OSError:
            continue
    raise RuntimeError(
        f"No available port found in range {start}â€“{start + max_attempts - 1}"
    )


def main():
    try:
        port = find_available_port()
    except RuntimeError as exc:
        print(f"ERROR: {exc}", file=sys.stderr)
        sys.exit(1)

    ip = get_local_ip()

    handler = http.server.SimpleHTTPRequestHandler

    try:
        with socketserver.TCPServer(("", port), handler) as httpd:
            print("Serving current directory on:")
            print(f"  http://{ip}:{port}")
            print()
            print("Press Ctrl+C to stop.")
            httpd.serve_forever()
    except OSError as exc:
        print(f"ERROR: Could not start server: {exc}", file=sys.stderr)
        sys.exit(1)
    except KeyboardInterrupt:
        print("\nServer stopped.")


if __name__ == "__main__":
    main()
