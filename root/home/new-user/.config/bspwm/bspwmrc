#!/bin/sh

# BSPWM Configuration

#### WORKSPACES ####
# Create 6 workspaces
bspc monitor -d 1 2 3 4 5 6

# Set all desktops to Monocle layout by default
for desktop in $(bspc query -D); do
	bspc desktop $desktop -l monocle
done

#### WINDOW APPEARANCE ####
# Border width
bspc config border_width         3

# Window gaps
bspc config window_gap           2
bspc config top_padding          19

# Border colors
bspc config normal_border_color  "#222222"   # normbordercolor
bspc config active_border_color  "#222222"
bspc config focused_border_color "#8b1a1a"   # selbordercolor
bspc config presel_feedback_color  "#8b1a1a"

#### WINDOW BEHAVIOR ####
bspc config split_ratio          0.50        # evenly split
bspc config borderless_monocle   false
bspc config gapless_monocle      false
bspc config single_monocle       false

#### POINTER BEHAVIOR ####
bspc config pointer_modifier     mod4        # Super key (MODKEY)
bspc config pointer_action1      move        # mod4+button1 = move
bspc config pointer_action2      resize_side
bspc config pointer_action3      resize_corner # mod4+button3 = resize

bspc config focus_follows_pointer false
bspc config pointer_follows_focus false

#### WINDOW RULES ####
# BSPWM doesn't have native swallowing, but we'll set up basic rules



#### AUTOSTART ####
systemctl --user import-environment DISPLAY XAUTHORITY
systemctl --user restart xdg-desktop-portal-gtk xdg-desktop-portal
gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'

# Launch SXHKD (keybinding daemon)
pgrep -x sxhkd > /dev/null || SXHKD_SHELL=/bin/bash sxhkd &

# Launch Polybar
pgrep -x polybar > /dev/null || polybar mybar &

# set Qalculate-gtk to float
bspc rule -a Qalculate-gtk state=floating center=on rectangle=716x470+0+0
bspc rule -a Qalculate state=floating center=on rectangle=716x470+0+0

# set Pavucontrol to float
# Sized for visibility of multiple audio streams and precise slider control
bspc rule -a pavucontrol state=floating center=on rectangle=800x600+0+0

# set Qt Settings to float
# Sized comfortably for tabbed lists and theme selection
bspc rule -a qt5ct state=floating center=on rectangle=900x600+0+0
bspc rule -a qt6ct state=floating center=on rectangle=900x600+0+0

# set Network Manager Connection Editor to float
# Sized to display connection list clearly
bspc rule -a nm-connection-editor state=floating center=on rectangle=600x500+0+0
bspc rule -a Nm-connection-editor state=floating center=on rectangle=600x500+0+0


# ... existing bspwmrc content ...

# -----------------------------------------------------------------------------
# AUTO-LAYER SCRIPT
# Automatically lower floating windows when they lose focus, raise them when focused.
# -----------------------------------------------------------------------------
bspc subscribe node_focus | while read -r _ _ _ node_id; do
    # 1. Find all floating windows on the current desktop that are NOT focused
    #    and set their layer to 'below'. They will disappear behind tiled windows.
    bspc query -N -n "any.local.floating.!focused" | xargs -r -n1 -I % bspc node % -l below

    # 2. If the newly focused window is floating, set its layer to 'above'
    #    so it pops to the foreground.
    bspc query -N -n "focused.floating" | xargs -r -n1 -I % bspc node % -l above
done &