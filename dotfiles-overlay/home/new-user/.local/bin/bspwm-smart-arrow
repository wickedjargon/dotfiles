#!/usr/bin/env python3
import subprocess
import json
import sys


"""Smart directional preselection for bspwm."""

STATE_FILE = "/tmp/bspwm_smart_arrow_state.json"

class BspwmSmartArrow:
    def notify(self, message):
         subprocess.run(["notify-send", "Smart Arrow", message])

    def bspc_query_nodes(self, args):
        cmd = ["bspc", "query", "-N"] + args
        try:
            return subprocess.check_output(cmd, text=True).strip().split('\n')
        except subprocess.CalledProcessError:
            return []

    def is_fullscreen(self):
        # bspc query -N -n focused.fullscreen returns node ID if true, exit 1 if false
        try:
            subprocess.check_call(["bspc", "query", "-N", "-n", "focused.fullscreen"], 
                                  stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            return True
        except subprocess.CalledProcessError:
            return False

    def get_layout(self):
        try:
            output = subprocess.check_output(["bspc", "query", "-T", "-d"], text=True)
            data = json.loads(output)
            return data.get("layout")
        except (subprocess.CalledProcessError, json.JSONDecodeError):
            return None

    def run(self, direction):
        if not direction:
            print(f"Usage: {sys.argv[0]} <direction>")
            sys.exit(1)

        # Get State
        # count focused leaf windows that are not hidden
        nodes = self.bspc_query_nodes(["-d", "focused", "-n", ".leaf.!hidden.window"])
        # If result is empty string (split gives ['']), count 0
        count = len([n for n in nodes if n])
        
        fullscreen = self.is_fullscreen()
        layout = self.get_layout()
        
        allowed = True
        
        if fullscreen:
            if count > 1:
                allowed = False
        elif layout == "monocle":
             if count > 1:
                 allowed = False
        
        if allowed:
             if count >= 1:
                 # Save State
                 state = {
                     "WAS_FULLSCREEN": fullscreen,
                     "PREV_LAYOUT": layout
                 }
                 try:
                     with open(STATE_FILE, 'w') as f:
                         json.dump(state, f)
                 except IOError:
                     pass # warn?
                     
                 # Exit Fullscreen
                 if fullscreen:
                      subprocess.run(["bspc", "node", "focused", "-t", "~fullscreen"])
                 
                 # Ensure Tiled
                 if layout != "tiled":
                      subprocess.run(["bspc", "desktop", "-l", "tiled"])
                 
                 # Preselect
                 subprocess.run(["bspc", "node", "-p", direction])
        else:
             self.notify("Split blocked: Multiple windows in Fullscreen/Monocle mode.")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <direction>")
        sys.exit(1)
    BspwmSmartArrow().run(sys.argv[1])
