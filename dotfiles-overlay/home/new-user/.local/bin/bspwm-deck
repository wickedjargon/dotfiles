#!/usr/bin/env python3
import subprocess
import json
import sys

"""Deck layout logic for bspwm."""

class BspwmDeck:
    def bspc_query(self, args):
        try:
            return subprocess.check_output(["bspc", "query"] + args, text=True).strip()
        except subprocess.CalledProcessError:
            return None

    def get_nodes_list(self, args):
        result = self.bspc_query(["-N"] + args)
        if not result:
            return []
        return result.split('\n')

    def run(self):
        # 1. Get focused and master
        focused = self.bspc_query(["-N", "-n", "focused"])
        master = self.bspc_query(["-N", "-n", "@/1"])
        
        # 2. Check layout
        try:
             output = self.bspc_query(["-T", "-d"])
             if output:
                 layout = json.loads(output).get("layout")
             else:
                 layout = None
        except (TypeError, json.JSONDecodeError):
             layout = None

        if layout != "tiled":
             sys.exit(0)

        # 3. Check if master
        if focused == master:
             sys.exit(0)

        # 3. Check hidden
        hidden_nodes = self.get_nodes_list(["-d", "-n", ".hidden"])
        
        if hidden_nodes:
            # Unhide all
            for node in hidden_nodes:
                 subprocess.run(["bspc", "node", node, "-g", "hidden=off"])
        else:
            # Hide everything except master and focused
            visible_nodes = self.get_nodes_list(["-d", "-n", ".window.!hidden"])
            
            for node in visible_nodes:
                # If node is NOT focused AND NOT master, hide it
                if node != focused and node != master:
                     subprocess.run(["bspc", "node", node, "-g", "hidden=on"])

if __name__ == "__main__":
    BspwmDeck().run()
